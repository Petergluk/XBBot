# XBalanseBot: Бот для Управления Экономикой Сообщества

## Оглавление
1.  [Введение](#введение)
2.  [Основные Возможности](#основные-возможности)
3.  [Архитектура Системы](#архитектура-системы)
4.  [Ключевые Концепции](#ключевые-концепции)
5.  [Установка и Запуск](#установка-и-запуск)
6.  [Тестирование](#тестирование)
7.  [Руководство Пользователя](#руководство-пользователя)
8.  [Руководство Администратора](#руководство-администратора)

## Введение
**XBalanseBot** — это Telegram-бот, разработанный на Python с использованием фреймворка `aiogram 3.x`. Он предназначен для создания и управления внутренней экономической системой в сообществах. Бот позволяет участникам иметь внутренние балансы, совершать переводы, подписываться на платные и бесплатные активности, а администраторам — гибко управлять всеми аспектами этой системы.

## Основные Возможности
*   **Личный баланс**: Каждый участник имеет свой счет во внутренней валюте (`Ӫ`).
*   **Переводы**: Пользователи могут мгновенно переводить средства друг другу с комментариями.
*   **Активности и События**: Возможность создавать "кружки по интересам" (активности) и привязанные к ним события (разовые или регулярные) с автоматическим списанием платы за участие.
*   **Гибкая Админ-панель**: Администраторы могут управлять пользователями, настройками системы, активностями и событиями через команды в Telegram.
*   **Демередж**: Механизм "отрицательного процента" для стимуляции оборота средств.
*   **Welcome-бонусы**: Автоматическое начисление бонусов новым участникам.
*   **Интеграция с платежными системами**: Прием пополнений через вебхуки (на примере Tribute).
*   **Логирование и Надежность**: Ведение логов и наличие набора автоматических тестов.

## Архитектура Системы
Проект имеет модульную структуру для легкой поддержки и расширения:
*   **`main.py`**: Главный файл, точка входа. Инициализирует все компоненты и запускает бота.
*   **`config.py`**: Файл конфигурации. Содержит все настройки: токен бота, ID группы, тексты по умолчанию и т.д.
*   **`app/database.py`**: Модуль для работы с базой данных SQLite. Инкапсулирует всю логику SQL-запросов.
*   **`app/handlers/`**: Пакет с обработчиками команд и колбэков от пользователей. Разделен на роутеры по функциональному признаку (`user_commands`, `admin_commands` и т.д.).
*   **`app/services/`**: Сервисный слой для бизнес-логики, не связанной напрямую с Telegram API (например, логика планировщика `APScheduler`, обработка вебхуков).
*   **`app/keyboards.py`**: Модуль для генерации всех inline-клавиатур.
*   **`app/states.py`**: Определения состояний для FSM-диалогов.
*   **`tests/`**: Пакет с автоматическими тестами на `pytest`.

## Ключевые Концепции
*   **Активность (Activity)**: Долгосрочное направление (например, "Книжный клуб", "Йога"). Пользователи подписываются на активность, чтобы получать уведомления и участвовать в связанных с ней событиях.
*   **Событие (Event)**: Конкретное мероприятие, привязанное к активности. Имеет дату, время и стоимость. Может быть разовым или регулярным (например, "Каждый вторник в 19:00"). При наступлении события плата автоматически списывается со всех подписчиков активности.
*   **Фонд Сообщества**: Системный счет, на который поступают средства от демереджа и ручных списаний.
*   **Роли**:
    *   `Пользователь`: Может проверять баланс, делать переводы, подписываться на активности.
    *   `Администратор`: Имеет доступ к расширенным командам для управления системой.
    *   `Супер-администратор`: Администратор, чей ID прописан в `config.py`. Он получает права администратора автоматически при запуске бота.

## Установка и Запуск
1.  **Клонируйте репозиторий:**
    ```bash
    git clone <your-repo-url>
    cd XBalanseBot
    ```
2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    python -m venv venv
    source venv/bin/activate  # Для Windows: venv\Scripts\activate
    ```
3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```
    *(Предполагается, что у вас есть файл `requirements.txt` со списком библиотек, таких как `aiogram`, `apscheduler`, `aiohttp`)*

4.  **Настройте `config.py`:**
    *   `BOT_TOKEN`: Укажите токен вашего Telegram-бота.
    *   `MAIN_GROUP_ID`: Укажите ID основной группы вашего сообщества.
    *   `SUPER_ADMIN_ID`: Укажите ваш Telegram ID, чтобы получить права администратора при первом запуске.
    *   `TRIBUTE_WEBHOOK_SECRET`: Установите надежный секретный ключ для вебхуков.

5.  **Запустите бота:**
    ```bash
    python main.py
    ```
    При первом запуске бот создаст файл базы данных `xbbot.db` и настроит супер-администратора.

## Тестирование
Для запуска автоматических тестов используется `pytest`. Убедитесь, что вы установили его (`pip install pytest pytest-asyncio`).
```bash
pytest -v